#%NASL_MIN_LEVEL 70300
##
# (C) Tenable Network Security, Inc.
##

include('deprecated_nasl_level.inc');
include('compat.inc');

if (description)
{
  script_id(500229);
  script_version("1.8");
  script_set_attribute(attribute:"plugin_modification_date", value:"2024/09/04");

  script_cve_id("CVE-2018-4850");
  script_xref(name:"ICSA", value:"18-137-03");

  script_name(english:"Siemens SIMATIC S7-400 CPU Improper Input Validation (CVE-2018-4850)");

  script_set_attribute(attribute:"synopsis", value:
"The remote OT asset is affected by a vulnerability.");
  script_set_attribute(attribute:"description", value:
"A vulnerability has been identified in SIMATIC S7-400 (incl. F) CPU hardware version 4.0 and below (All versions),
SIMATIC S7-400 (incl. F) CPU hardware version 5.0 (All firmware versions < V5.2), SIMATIC S7-400H CPU hardware version
4.5 and below (All versions). The affected CPUs improperly validate S7 communication packets which could cause a Denial-
of-Service condition of the CPU. The CPU will remain in DEFECT mode until manual restart.  

This plugin only works with
Tenable.ot. Please visit https://www.tenable.com/products/tenable-ot for more information.");
  # https://www.siemens.com/global/en/home/products/services/cert.html#SecurityPublications
  script_set_attribute(attribute:"see_also", value:"http://www.nessus.org/u?4c43d07e");
  script_set_attribute(attribute:"see_also", value:"https://cert-portal.siemens.com/productcert/pdf/ssa-914382.pdf");
  script_set_attribute(attribute:"see_also", value:"https://www.cisa.gov/news-events/ics-advisories/icsa-18-137-03");
  script_set_attribute(attribute:"see_also", value:"http://www.securityfocus.com/bid/104217");
  script_set_attribute(attribute:"solution", value:
"The following text was originally created by the Cybersecurity and Infrastructure Security Agency (CISA). The original
can be found at CISA.gov.

Siemens has released updates for several affected products and recommends users update to the new version.

- SIMATIC S7-400 (incl. F) CPU all hardware versions prior to, and including, hardware v4.0: Upgrade to hardware v5.0 or
newer.

https://support.industry.siemens.com/cs/ww/en/view/109483507

- SIMATIC S7-400 (incl. F) CPU hardware v5.0 with firmware versions prior to v5.2: Update to firmware v5.2 or newer.

https://support.industry.siemens.com/cs/ww/en/view/109474827

- SIMATIC S7-400H CPU all hardware versions prior to v4.5: Upgrade to hardware v6.0 or newer.

https://support.industry.siemens.com/cs/ww/en/view/75407031

Siemens has identified the following specific workarounds and mitigations that users can apply to reduce the risk:

- Apply cell protection concept: https://www.siemens.com/cert/operational-guidelines-industrial-security
- Use VPN for protecting network communication between cells.
- Apply Defense-in-Depth: https://www.siemens.com/cert/operational-guidelines-industrial-security

As a general security measure, Siemens strongly recommends protecting network access to devices with appropriate
mechanisms. In order to run the devices in a protected IT environment, Siemens specifically recommends users configure
the environment according to Siemensâ€™ Operational Guidelines for Industrial Security and follow the recommendations in
the product manuals.

Additional information on industrial security by Siemens can be found at:

https://www.siemens.com/industrialsecurity

For more information on this vulnerability and associated software updates, please see Siemens security advisory
SSA-914382 on their website:

https://www.siemens.com/cert/advisories");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:N/I:N/A:P");
  script_set_cvss_temporal_vector("CVSS2#E:U/RL:OF/RC:C");
  script_set_cvss3_base_vector("CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H");
  script_set_cvss3_temporal_vector("CVSS:3.0/E:U/RL:O/RC:C");
  script_set_attribute(attribute:"cvss_score_source", value:"CVE-2018-4850");

  script_set_attribute(attribute:"exploitability_ease", value:"No known exploits are available");
  script_set_attribute(attribute:"exploit_available", value:"false");

  script_set_attribute(attribute:"vuln_publication_date", value:"2018/05/16");
  script_set_attribute(attribute:"patch_publication_date", value:"2018/05/16");
  script_set_attribute(attribute:"plugin_publication_date", value:"2022/02/07");

  script_set_attribute(attribute:"plugin_type", value:"remote");
  script_set_attribute(attribute:"cpe", value:"cpe:/o:siemens:simatic_s7-400_firmware:4.0");
  script_set_attribute(attribute:"cpe", value:"cpe:/o:siemens:simatic_s7-400_firmware:5.0");
  script_set_attribute(attribute:"cpe", value:"cpe:/o:siemens:simatic_s7-400h_firmware");
  script_set_attribute(attribute:"generated_plugin", value:"former");
  script_end_attributes();

  script_category(ACT_GATHER_INFO);
  script_family(english:"Tenable.ot");

  script_copyright(english:"This script is Copyright (C) 2022-2024 and is owned by Tenable, Inc. or an Affiliate thereof.");

  script_dependencies("tenable_ot_api_integration.nasl");
  script_require_keys("Tenable.ot/Siemens");

  exit(0);
}


include('tenable_ot_cve_funcs.inc');

get_kb_item_or_exit('Tenable.ot/Siemens');

var asset = tenable_ot::assets::get(vendor:'Siemens');

var vuln_cpes = {
    "cpe:/o:siemens:simatic_s7-400_firmware:4.0" :
        {"versionEndExcluding" : "4.0", "family" : "S7400"},
    "cpe:/o:siemens:simatic_s7-400_firmware:5.0" :
        {"versionStartIncluding" : "5.0", "versionEndExcluding" : "5.2", "family" : "S7400"},
    "cpe:/o:siemens:simatic_s7-400h_firmware" :
        {"versionEndIncluding" : "4.5", "family" : "S7400"}
};

tenable_ot::cve::compare_and_report(asset:asset, cpes:vuln_cpes, severity:SECURITY_WARNING);
