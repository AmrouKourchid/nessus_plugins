#%NASL_MIN_LEVEL 70300
##
# (C) Tenable, Inc.
##

include('deprecated_nasl_level.inc');
include('compat.inc');

if (description)
{
  script_id(500632);
  script_version("1.8");
  script_set_attribute(attribute:"plugin_modification_date", value:"2024/09/04");

  script_cve_id("CVE-2021-40368");
  script_xref(name:"ICSA", value:"22-104-12");

  script_name(english:"Siemens SIMATIC S7-400 Improper Restriction of Operations Within the Bounds of a Memory Buffer (CVE-2021-40368)");

  script_set_attribute(attribute:"synopsis", value:
"The remote OT asset is affected by a vulnerability.");
  script_set_attribute(attribute:"description", value:
"A vulnerability has been identified in SIMATIC S7-400 H V6 CPU family
(incl. SIPLUS variants) (All versions < V6.0.10), SIMATIC S7-400 PN/DP
V7 CPU family (incl. SIPLUS variants) (All versions), SIMATIC S7-410
V10 CPU family (incl. SIPLUS variants) (All versions < V10.1), SIMATIC
S7-410 V8 CPU family (incl. SIPLUS variants) (All versions). Affected
devices improperly handle specially crafted packets sent to port
102/tcp. This could allow an attacker to create a Denial-of-Service
condition. A restart is needed to restore normal operations.

This plugin only works with Tenable.ot.
Please visit https://www.tenable.com/products/tenable-ot for more information.");
  script_set_attribute(attribute:"see_also", value:"https://cert-portal.siemens.com/productcert/pdf/ssa-557541.pdf");
  script_set_attribute(attribute:"see_also", value:"https://www.cisa.gov/news-events/ics-advisories/icsa-22-104-12");
  script_set_attribute(attribute:"solution", value:
"The following text was originally created by the Cybersecurity and Infrastructure Security Agency (CISA). The original
can be found at CISA.gov.

Siemens recommends updating their software to the most current version where available:

- SIMATIC S7-400 HV6 CPU family (incl. SIPLUS variants): Update to v6.0.10 or later
- SIMATIC S7-400 PN/DP V7 CPU family (incl. SIPLUS variants): No current fix is available

- SIMATIC S7-410 V8 CPU family (incl. SIPLUS variants): Update to v8.2.3 or later

- SIMATIC S7-410 V10 CPU family (incl. SIPLUS variants): Update to v10.1 or later

- To obtain SIMATIC S7-410 v10.1 contact Siemens support

Siemens has identified the following specific workarounds and mitigations users can apply to reduce the risk:

- Limit access to Port 102/TCP to trusted users and systems only

As a general security measure, Siemens strongly recommends protecting network access to devices with appropriate
mechanisms. In order to operate the devices in a protected IT environment, Siemens recommends configuring the
environment according to the Siemens operational guidelines for industrial security and following the recommendations in
the product manuals.

For additional information, please refer to Siemens Security Advisory SSA-557541");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:N/C:N/I:N/A:P");
  script_set_cvss_temporal_vector("CVSS2#E:U/RL:OF/RC:C");
  script_set_cvss3_base_vector("CVSS:3.0/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H");
  script_set_cvss3_temporal_vector("CVSS:3.0/E:U/RL:O/RC:C");
  script_set_attribute(attribute:"cvss_score_source", value:"CVE-2021-40368");

  script_set_attribute(attribute:"exploitability_ease", value:"No known exploits are available");
  script_set_attribute(attribute:"exploit_available", value:"false");
  script_cwe_id(119);

  script_set_attribute(attribute:"vuln_publication_date", value:"2022/04/12");
  script_set_attribute(attribute:"patch_publication_date", value:"2022/04/12");
  script_set_attribute(attribute:"plugin_publication_date", value:"2022/04/28");

  script_set_attribute(attribute:"plugin_type", value:"remote");
  script_set_attribute(attribute:"cpe", value:"cpe:/o:siemens:simatic_s7-400h_v6_firmware");
  script_set_attribute(attribute:"cpe", value:"cpe:/o:siemens:simatic_s7-400_pn%2fdp_v7_firmware");
  script_set_attribute(attribute:"generated_plugin", value:"former");
  script_end_attributes();

  script_category(ACT_GATHER_INFO);
  script_family(english:"Tenable.ot");

  script_copyright(english:"This script is Copyright (C) 2022-2024 and is owned by Tenable, Inc. or an Affiliate thereof.");

  script_dependencies("tenable_ot_api_integration.nasl");
  script_require_keys("Tenable.ot/Siemens");

  exit(0);
}


include('tenable_ot_cve_funcs.inc');

get_kb_item_or_exit('Tenable.ot/Siemens');

var asset = tenable_ot::assets::get(vendor:'Siemens');

var vuln_cpes = {
    "cpe:/o:siemens:simatic_s7-400h_v6_firmware" :
        {"versionStartIncluding" : "6.0", "versionEndExcluding" : "6.0.10", "family" : "S7400"},
    "cpe:/o:siemens:simatic_s7-400_pn%2fdp_v7_firmware" :
        {"versionStartIncluding" : "7.0", "versionEndExcluding" : "7.0.3", "family" : "S7400"}
};

tenable_ot::cve::compare_and_report(asset:asset, cpes:vuln_cpes, severity:SECURITY_WARNING);
