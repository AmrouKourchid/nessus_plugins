#TRUSTED 98a12c1b6f6b0f029c4d75fb928c11e9d7ee0e8cdebffd330983a5de7a959672a7750008fbd31f7cb71282f7812d44cd6d31aa10f53b0173d2d408e7e439f0ec226b3c95e71ea699484c9d3fcdf549079e7e126d85e75924f3963089f12564e9b817b819179089f81c4890e5a90cd7401ef619219c284662d4694ab9b62ae6f8693c8479795d5b164b1e609bd03c6a42875b51746d36d6a93377611d045f81153d80c569cb6823f99de6a0abaf528d034960d0af429584cca3699b9a41fa612e559457d283bd6cd4291c636a89e96fb8e9aca7091a8edb055a01786e5bddfbbcc6d241e32102ad32ed07d1bc518b5e4b5869a0a2a4e8636360d932f55412503fc9929efdf75f383c0280adb09b70e033f320a770d0fb2973f3dcb86dbfbed43d2caeffc4208466b38798a9854e5b8e0cc5c4b88eb1e114686bb28c8e5f02bdf918d87e4ca9bb6e9bceccf5b633c6d50d979f046a138153b9204fee3738caed30df55acbe0ad1585ee4596804158486ff94d1f26a37ab6a1a5417602ae141de3e417115213a2f2d925d4580cf0eaa5864be56d1d9c77e41ce8bf6da28f771c6d82bb7f9ad9fdb8470512ea14a0a4e0470340be3304e06981dfcd53608bc48197d5f8ddcfca773af343ee170f7214713a22cccaae65108b0b51e3cd03b0e01eb633e135eb3ae7e8e6f7ad97e678bda3e46280ddecb99a46ff76ec6c91130018c2e
#TRUST-RSA-SHA256 1f53950a0315f258e0ff279638013b7fbd6498fb2701ac98b6ffa02f4fe17bb5c9796b379df73f66a719feb086a524c1446b2d0ab1d06189066c2c9968f4f9cf0396fe0faf31970ffc12e7510fee14a9d1928161165a25b34b97f400501cec84faa8ea9104fa49dba40edc8ae1cbb31c277734bfd6d926dc93299180d9649f9b6c24da5afdc6c6c5bae61d8ea5c7bbf7db4b878f135bdfedd0b3b4c3c13850eee6bdabd5e2b9ca42de1432196a29fed00e71fe932db1f2e8ec3adb0eebe168c7035520b412868898b26c75130d17d8af87ad5dc976fea5891de3be43b28104edad36f0baf6c1f35c6f600aab7d089439e5865f611ca5293ef5572728b31d959f0bc2fcf9c927171701a80b525fb91aebb4de46ac055fab3f44e88690df6793e7a1593883310777d510f690b0f858e8c8ebbc90dea02d6e7827ddf802714554bba9a85994ff1315de32b96bdb95b90bb5816bfe2180a942c11629daf4ffb37b603e03f98cb565a38a44c5ce205cf61b25c18405b7bd5abcd1c2b796a43abf727af003306ab283fb3955ff40cf43f207c24b284ec611a4e2720947334b62967ab37a8b84bacbb7d5796081d07a90702317ec53565a821f4ad27aa9e138ce72e95991559a0d7f2b5fe1cacb431c3effd337aebed45b3215d8c8526766fdbbaf80598a1154e1faf2f317d2dcc69c003a1bc335b9ecea4366907911470a08d5a58874
# (C) Tenable Network Security, Inc.

##
# check if target is Viptela based on target SSH login banner.
##
function is_viptela_ssh()
{
  var result = FALSE;
  if("viptela" >< host_info_key_val['remote_ssh_userauth_banner'])
  {
    dbg::log(src:'is_viptela_ssh', msg:'"viptela" found in SSH banner.');
    result = TRUE;
  }
  else if("Welcome to Viptela CLI" >< host_info_key_val['post_login_buffer'])
  {
    dbg::log(src:'is_viptela_ssh', msg:'"Welcome to Viptela CLI" found in SSH post auth buffer.');
    result = TRUE;
  }
  return result;
}

##
# check if this is a viptela device based on information collected.
##
function viptela_pre_check_fail()
{
  # attempt to verify that target is viptela via SSH login banner.
  if(is_viptela_ssh())
    return FALSE;

  # have we already checked that the host is not viptela?
  if(host_info_key_val['host_not_viptela'])
    return TRUE;

  if(!empty_or_null(host_info_key_val['show_system_status_unrecognized']) &&
     host_info_key_val['show_system_status_unrecognized'] !~ cisco_viptela_check['test_cmd_regex'])
    return TRUE;

  # Not Viptela if one of the following devices
  if (is_cisco_ssh() ||
      is_panos() ||
      is_huawei() ||
      is_asyncos() ||
      is_staros() ||
      is_ivanti_sentry() ||
      is_screenos() ||
      is_exos() ||
      is_qnap_standard() ||
      is_dell_idrac() ||
      is_infoblox_nios() ||
      is_aruba_cppm() ||
      is_arrayos())
  {
    return TRUE;
  }

  return FALSE;
}

##
# callback for systems with "Viptela (tm) vedge Operating System Software" in output of show system status.
##
function handle_viptela(session, use_shell_handler, channel, cmd_res)
{
  report += '\nThe output of the "show system status" was :\n' + cmd_res + '\n\n'
          + 'Command support has been enabled for Cisco Viptela CLI.\n'
          + 'Further identification will be handled by subsequent plugins.\n';
  replace_kb_item(name:'target_shell', value:'Cisco Viptela CLI');
  replace_kb_item(name:"Host/Cisco/Viptela/show_system_status", value:cmd_res);
  replace_kb_item(name:'Host/Cisco/Viptela', value:TRUE);
  sshlib::set_support_level(level: sshlib::SSH_LIB_LOCAL_CHECKS_UNAVAILABLE);
}

##
# callback for systems without "Viptela (tm) vedge Operating System Software" in show system status
##
function handle_not_viptela(session, use_shell_handler, channel, cmd_res)
{
  if (use_shell_handler) store_shell_info();
  if(!empty_or_null(cmd_res))
  {
    replace_kb_item(name:"Host/show_system_status", value:cmd_res);

    # store more details for other handlers to use.
    host_info_key_val['show_system_status_unrecognized'] = cmd_res;
    host_info_key_val['host_not_viptela'] = TRUE;
  }
}
