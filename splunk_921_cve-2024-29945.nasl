#%NASL_MIN_LEVEL 80900
##
# (C) Tenable, Inc.
##

include('compat.inc');

if (description)
{
  script_id(192633);
  script_version("1.3");
  script_set_attribute(attribute:"plugin_modification_date", value:"2024/07/12");

  script_cve_id("CVE-2024-29945");
  script_xref(name:"IAVA", value:"2024-A-0187-S");

  script_name(english:"Splunk Enterprise 9.0.0 < 9.0.9, 9.1.0 < 9.1.4, 9.2.0 < 9.2.1 (SVD-2024-0301)");

  script_set_attribute(attribute:"synopsis", value:
"An application running on a remote web server host is affected by a vulnerability");
  script_set_attribute(attribute:"description", value:
"The version of Splunk installed on the remote host is prior to tested version. It is, therefore, affected by a
vulnerability as referenced in the SVD-2024-0301 advisory.

  - In Splunk Enterprise versions below 9.2.1, 9.1.4, and 9.0.9, the software potentially exposes
    authentication tokens during the token validation process. This exposure happens when either Splunk
    Enterprise runs in debug mode or the JsonWebToken component has been configured to log its activity at the
    DEBUG logging level. (CVE-2024-29945)

Note that Nessus has not tested for this issue but has instead relied only on the application's self-reported version
number.");
  script_set_attribute(attribute:"see_also", value:"https://advisory.splunk.com/advisories/SVD-2024-0301.html");
  script_set_attribute(attribute:"solution", value:
"There are multiple solutions depending on how you have configured the Splunk Enterprise instance.First, determine
whether or not debug logging is on, either globally or for the JsonWebToken component. You must log into the Splunk
Enterprise instance as an admin user or equivalent to perform these actions.To determine the current global logging mode
on the instance:In a web browser, visit the Server Logging Settings page in Splunk Web at /en-
US/manager/system/server/logger.Review the Logging Level column on the page that loads. If every row in this column
shows DEBUG as the logging level, then the Splunk Enterprise instance is in debug mode. Otherwise, it is not in debug
mode.To determine the current logging level for the JsonWebToken processor:In a web browser, search for the JsonWebToken
processor configuration by visiting /en-US/manager/system/server/logger?search=JsonWebToken.Review the Logging level
column for the processor. If this row has a value of DEBUG, then the processor currently logs its activity at the DEBUG
level.See Enable debug logging for more information.If either of these steps determines that debug logging is on, either
globally or for the JsonWebToken component, then remedy the problem by performing the following tasks:Upgrade Splunk
Enterprise to versions 9.2.1, 9.1.4, 9.0.9, or higher.Delete the following log file on the Splunk Enterprise instance:
$SPLUNK_HOME/var/log/splunk/splunkd.logLog into Splunk Web on the Splunk Enterprise instance and delete all log file
events for the JsonWebToken component from the _internal index by running the following search command: index=_internal
component=JsonWebToken | deleteNote: The delete SPL command requires the can_delete role, which administrators do not
receive by default. See delete for more info on the delete search command.While you are logged in, rotate any
potentially exposed authentication tokens. See Manage or delete authentication tokens for more information.");
  script_set_attribute(attribute:"agent", value:"all");
  script_set_cvss_base_vector("CVSS2#AV:N/AC:L/Au:M/C:C/I:C/A:C");
  script_set_cvss_temporal_vector("CVSS2#E:U/RL:OF/RC:C");
  script_set_cvss3_base_vector("CVSS:3.0/AV:N/AC:L/PR:H/UI:N/S:U/C:H/I:H/A:H");
  script_set_cvss3_temporal_vector("CVSS:3.0/E:U/RL:O/RC:C");
  script_set_attribute(attribute:"cvss_score_source", value:"CVE-2024-29945");

  script_set_attribute(attribute:"exploitability_ease", value:"No known exploits are available");
  script_set_attribute(attribute:"exploit_available", value:"false");
  script_cwe_id(532);

  script_set_attribute(attribute:"vuln_publication_date", value:"2024/03/27");
  script_set_attribute(attribute:"patch_publication_date", value:"2024/03/27");
  script_set_attribute(attribute:"plugin_publication_date", value:"2024/03/27");

  script_set_attribute(attribute:"potential_vulnerability", value:"true");
  script_set_attribute(attribute:"plugin_type", value:"combined");
  script_set_attribute(attribute:"cpe", value:"cpe:/a:splunk:splunk");
  script_set_attribute(attribute:"generated_plugin", value:"current");
  script_set_attribute(attribute:"stig_severity", value:"I");
  script_end_attributes();

  script_category(ACT_GATHER_INFO);
  script_family(english:"CGI abuses");

  script_copyright(english:"This script is Copyright (C) 2024 and is owned by Tenable, Inc. or an Affiliate thereof.");

  script_dependencies("splunkd_detect.nasl", "splunk_web_detect.nasl", "macos_splunk_installed.nbin", "splunk_win_installed.nbin", "splunk_nix_installed.nbin");
  script_require_keys("installed_sw/Splunk", "Settings/ParanoidReport");

  exit(0);
}

include('vcf.inc');
include('vcf_extras_splunk.inc');

if (report_paranoia < 2) audit(AUDIT_PARANOID);

var app_info = vcf::splunk::get_app_info();

var constraints = [
  { 'min_version' : '9.0.0', 'fixed_version' : '9.0.9', 'license' : 'Enterprise' },
  { 'min_version' : '9.1.0', 'fixed_version' : '9.1.4', 'license' : 'Enterprise' },
  { 'min_version' : '9.2.0', 'fixed_version' : '9.2.1', 'license' : 'Enterprise' }
];
vcf::splunk::check_version_and_report(
    app_info:app_info,
    constraints:constraints,
    severity:SECURITY_HOLE
);
